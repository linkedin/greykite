<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>greykite.algo.forecast.silverkite.forecast_silverkite_helper &mdash; Greykite Library  documentation</title>
      <link rel="stylesheet" href="../../../../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../../../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../../../../_static/sg_gallery.css" type="text/css" />
      <link rel="stylesheet" href="../../../../../_static/sg_gallery-binder.css" type="text/css" />
      <link rel="stylesheet" href="../../../../../_static/sg_gallery-dataframe.css" type="text/css" />
      <link rel="stylesheet" href="../../../../../_static/sg_gallery-rendered-html.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../../../../" id="documentation_options" src="../../../../../_static/documentation_options.js"></script>
        <script src="../../../../../_static/jquery.js"></script>
        <script src="../../../../../_static/underscore.js"></script>
        <script src="../../../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../../../../_static/doctools.js"></script>
        <script src="../../../../../_static/sphinx_highlight.js"></script>
    <script src="../../../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../../../../index.html" class="icon icon-home"> Greykite Library
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Overview</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../pages/overview/100_forecast_intro.html">The Greykite Forecast model</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../pages/overview/200_ad_intro.html">The Greykite Anomaly Detection model</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Quick Start</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../gallery/quickstart/index.html">Quickstart</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../gallery/tutorials/index.html">Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../gallery/templates/index.html">Model Templates</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Step by Step</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../pages/stepbystep/0000_stepbystep.html">Forecasting Process</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../pages/stepbystep/0100_choose_model.html">Choose a Model</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../pages/stepbystep/0200_choose_template.html">Choose a Model Template</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../pages/stepbystep/0300_input.html">Examine Input Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../pages/stepbystep/0400_configuration.html">Configure a Forecast</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../pages/stepbystep/0500_output.html">Check Forecast Result</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../pages/stepbystep/0600_debug.html">Debugging</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Tuning the Model Components</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../pages/model_components/0100_introduction.html">Greykite models and components</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../pages/model_components/0200_growth.html">Growth</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../pages/model_components/0300_seasonality.html">Seasonality</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../pages/model_components/0400_events.html">Holidays and Events</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../pages/model_components/0500_changepoints.html">Changepoints</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../pages/model_components/0600_custom.html">Custom Parameters</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../pages/model_components/0700_regressors.html">Regressors</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../pages/model_components/0800_autoregression.html">Auto-regression</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../pages/model_components/0900_uncertainty.html">Uncertainty Intervals</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../pages/model_components/1000_override.html">Pre-processing, Selective Grid Search</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Benchmarking</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../pages/benchmarking/benchmarking.html">Benchmarking</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Miscellaneous</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../pages/miscellaneous/reconcile_forecasts.html">Reconcile Forecasts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../pages/miscellaneous/store_model.html">Model store and load</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Changelog</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../pages/changelog/changelog.html">1.0.0 (2024-01-07)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../pages/changelog/changelog.html#id2">0.5.1 (2023-06-01)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../pages/changelog/changelog.html#id3">0.5.0 (2023-04-03)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../pages/changelog/changelog.html#id4">0.4.0 (2022-07-15)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../pages/changelog/changelog.html#id5">0.3.0 (2021-12-14)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../pages/changelog/changelog.html#id6">0.2.0 (2021-06-30)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../pages/changelog/changelog.html#id7">0.1.1 (2021-05-12)</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../pages/autodoc/doc.html">Docs</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../../index.html">Greykite Library</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../../../index.html" class="icon icon-home"></a></li>
          <li class="breadcrumb-item"><a href="../../../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">greykite.algo.forecast.silverkite.forecast_silverkite_helper</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for greykite.algo.forecast.silverkite.forecast_silverkite_helper</h1><div class="highlight"><pre>
<span></span><span class="c1"># BSD 2-CLAUSE LICENSE</span>

<span class="c1"># Redistribution and use in source and binary forms, with or without modification,</span>
<span class="c1"># are permitted provided that the following conditions are met:</span>

<span class="c1"># Redistributions of source code must retain the above copyright notice, this</span>
<span class="c1"># list of conditions and the following disclaimer.</span>
<span class="c1"># Redistributions in binary form must reproduce the above copyright notice,</span>
<span class="c1"># this list of conditions and the following disclaimer in the documentation</span>
<span class="c1"># and/or other materials provided with the distribution.</span>
<span class="c1"># THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS &quot;AS IS&quot; AND</span>
<span class="c1"># ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED</span>
<span class="c1"># WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE</span>
<span class="c1"># DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR</span>
<span class="c1"># #ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES</span>
<span class="c1"># (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;</span>
<span class="c1"># LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND</span>
<span class="c1"># ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT</span>
<span class="c1"># (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS</span>
<span class="c1"># SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</span>
<span class="c1"># original author: Reza Hosseini</span>
<span class="sd">&quot;&quot;&quot;Helper functions for</span>
<span class="sd">`~greykite.algo.forecast.silverkite.forecast_silverkite.py.`</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Optional</span>

<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="kn">from</span> <span class="nn">greykite.common.constants</span> <span class="kn">import</span> <span class="n">TimeFeaturesEnum</span>
<span class="kn">from</span> <span class="nn">greykite.common.enums</span> <span class="kn">import</span> <span class="n">SimpleTimeFrequencyEnum</span>
<span class="kn">from</span> <span class="nn">greykite.common.features.timeseries_features</span> <span class="kn">import</span> <span class="n">build_time_features_df</span>
<span class="kn">from</span> <span class="nn">greykite.common.features.timeseries_features</span> <span class="kn">import</span> <span class="n">get_default_origin_for_time_vars</span>


<span class="k">def</span> <span class="nf">get_similar_lag</span><span class="p">(</span><span class="n">freq_in_days</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;For a given frequency, it returns a lag which is likely to be most correlated</span>
<span class="sd">    to the observation at current time.</span>

<span class="sd">    For daily data, this will return 7 and for hourly data it will return 24*7.</span>
<span class="sd">    In general for sub-weekly frequencies, it returns the lag which corresponds to</span>
<span class="sd">    the same time in the last week.</span>
<span class="sd">    For data which is weekly or with frequencies larger than a week, it returns None.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    freq_in_days : `float`</span>
<span class="sd">        The time frequency of the timeseries given in day units.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    similar_lag : `int` or None</span>
<span class="sd">        The returned lag or None.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">similar_lag</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="c1"># Get the number of observations per week</span>
    <span class="n">obs_num_per_week</span> <span class="o">=</span> <span class="mi">7</span> <span class="o">/</span> <span class="n">freq_in_days</span>

    <span class="k">if</span> <span class="n">obs_num_per_week</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">similar_lag</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">obs_num_per_week</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">similar_lag</span>


<span class="k">def</span> <span class="nf">get_default_changepoints_dict</span><span class="p">(</span>
        <span class="n">changepoints_method</span><span class="p">,</span>
        <span class="n">num_days</span><span class="p">,</span>
        <span class="n">forecast_horizon_in_days</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get a changepoint dictionary based on the number of days in the observed</span>
<span class="sd">    timeseries and forecast horizon length in days to be provided as input to</span>
<span class="sd">    `~greykite.algo.forecast.silverkite.forecast_silverkite.SilverkiteForecast.forecast`.</span>
<span class="sd">    For the &quot;uniform&quot; method, we place the change points at a distance of</span>
<span class="sd">    ``max(28, forecast_horizon)``.</span>
<span class="sd">    For the &quot;auto&quot; method, we have used some defaults which seem to work for general</span>
<span class="sd">    applications::</span>

<span class="sd">        changepoints_dict = {</span>
<span class="sd">            &quot;method&quot;: &quot;auto&quot;,</span>
<span class="sd">            &quot;yearly_seasonality_order&quot;: 10,</span>
<span class="sd">            &quot;resample_freq&quot;: &quot;7D&quot;,</span>
<span class="sd">            &quot;regularization_strength&quot;: 0.8,</span>
<span class="sd">            &quot;actual_changepoint_min_distance&quot;: &quot;14D&quot;,</span>
<span class="sd">            &quot;potential_changepoint_distance&quot;: &quot;7D&quot;,</span>
<span class="sd">            &quot;no_changepoint_distance_from_end&quot;: &quot;14D&quot;}</span>

<span class="sd">    If the length of data is smaller than ``2*max(28, forecast_horizon)``,</span>
<span class="sd">    the function will return None for all methods.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    changepoints_method : `str`</span>
<span class="sd">        The method to locate changepoints.</span>
<span class="sd">        Valid options:</span>

<span class="sd">            - &quot;uniform&quot;. Places changepoints evenly spaced changepoints to allow</span>
<span class="sd">            growth to change. The distance between the uniform change points is</span>
<span class="sd">            set to be ``max(28, forecast_horizon)``</span>
<span class="sd">            - &quot;auto&quot;. Automatically detects change points.</span>
<span class="sd">            For configuration, see</span>
<span class="sd">            `~greykite.algo.changepoint.adalasso.changepoint_detector.ChangepointDetector.find_trend_changepoints`</span>

<span class="sd">        For more details for both methods, also check the documentation for</span>
<span class="sd">        `~greykite.algo.forecast.silverkite.forecast_silverkite.SilverkiteForecast.forecast`.</span>
<span class="sd">    num_days : `int`</span>
<span class="sd">        Number of days appearing in the observed timeseries.</span>
<span class="sd">    forecast_horizon_in_days : `float`</span>
<span class="sd">        The length of the forecast horizon in days.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    changepoints_dict : `dict` or None</span>
<span class="sd">        A dictionary with change points information to be used as input to</span>
<span class="sd">        `~greykite.algo.forecast.silverkite.forecast_silverkite.SilverkiteForecast.forecast`.</span>
<span class="sd">        See that function&#39;s documentation for more details.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">changepoints_dict</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="c1"># A reasonable distance defined based on ``forecast_horizon``</span>
    <span class="c1"># Here the minimum is set at 28 days</span>
    <span class="n">uniform_distance</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">28</span><span class="p">,</span> <span class="n">forecast_horizon_in_days</span><span class="p">)</span>
    <span class="c1"># Number of change points for &quot;uniform&quot;</span>
    <span class="c1"># Also if this number is zero both methods will return `None`</span>
    <span class="n">changepoint_num</span> <span class="o">=</span> <span class="n">num_days</span> <span class="o">//</span> <span class="n">uniform_distance</span> <span class="o">-</span> <span class="mi">1</span>

    <span class="k">if</span> <span class="n">changepoint_num</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">changepoints_method</span> <span class="o">==</span> <span class="s2">&quot;uniform&quot;</span><span class="p">:</span>
            <span class="n">changepoints_dict</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;method&quot;</span><span class="p">:</span> <span class="s2">&quot;uniform&quot;</span><span class="p">,</span>
                <span class="s2">&quot;n_changepoints&quot;</span><span class="p">:</span> <span class="n">changepoint_num</span><span class="p">,</span>
                <span class="s2">&quot;continuous_time_col&quot;</span><span class="p">:</span> <span class="n">TimeFeaturesEnum</span><span class="o">.</span><span class="n">ct1</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                <span class="s2">&quot;growth_func&quot;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">}</span>

        <span class="k">elif</span> <span class="n">changepoints_method</span> <span class="o">==</span> <span class="s2">&quot;auto&quot;</span><span class="p">:</span>
            <span class="n">changepoints_dict</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;method&quot;</span><span class="p">:</span> <span class="s2">&quot;auto&quot;</span><span class="p">,</span>
                <span class="s2">&quot;yearly_seasonality_order&quot;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
                <span class="s2">&quot;resample_freq&quot;</span><span class="p">:</span> <span class="s2">&quot;7D&quot;</span><span class="p">,</span>
                <span class="s2">&quot;regularization_strength&quot;</span><span class="p">:</span> <span class="mf">0.8</span><span class="p">,</span>
                <span class="s2">&quot;actual_changepoint_min_distance&quot;</span><span class="p">:</span> <span class="s2">&quot;14D&quot;</span><span class="p">,</span>
                <span class="s2">&quot;potential_changepoint_distance&quot;</span><span class="p">:</span> <span class="s2">&quot;7D&quot;</span><span class="p">,</span>
                <span class="s2">&quot;no_changepoint_distance_from_end&quot;</span><span class="p">:</span> <span class="s2">&quot;14D&quot;</span><span class="p">}</span>

    <span class="k">return</span> <span class="n">changepoints_dict</span>


<div class="viewcode-block" id="get_silverkite_uncertainty_dict"><a class="viewcode-back" href="../../../../../pages/autodoc/doc.html#greykite.algo.forecast.silverkite.forecast_silverkite_helper.get_silverkite_uncertainty_dict">[docs]</a><span class="k">def</span> <span class="nf">get_silverkite_uncertainty_dict</span><span class="p">(</span>
        <span class="n">uncertainty</span><span class="p">,</span>
        <span class="n">simple_freq</span><span class="o">=</span><span class="n">SimpleTimeFrequencyEnum</span><span class="o">.</span><span class="n">DAY</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
        <span class="n">coverage</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns an uncertainty_dict for</span>
<span class="sd">    `~greykite.algo.forecast.silverkite.forecast_silverkite.SilverkiteForecast.forecast`</span>
<span class="sd">    input parameter: uncertainty_dict.</span>

<span class="sd">    The logic is as follows:</span>

<span class="sd">        - If ``uncertainty`` is passed as dict:</span>
<span class="sd">            - If ``quantiles`` are not passed through ``uncertainty`` we fill them</span>
<span class="sd">              using `coverage`.</span>
<span class="sd">            - If ``coverage`` also missing or quantiles calculated</span>
<span class="sd">              in two ways (via ``uncertainty[&quot;params&quot;][&quot;quantiles&quot;]`` and ``coverage``)</span>
<span class="sd">              do not match, we throw Exceptions</span>

<span class="sd">        - If ``uncertainty==&quot;auto&quot;``:</span>
<span class="sd">            - We provide defaults based on time frequency of data.</span>
<span class="sd">            - Specify ``uncertainty[&quot;params&quot;][&quot;quantiles&quot;]`` based on</span>
<span class="sd">              ``coverage`` if provided, otherwise the default coverage is 0.95.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    uncertainty : `str` or `dict` or None</span>
<span class="sd">        It specifies what method should be used for uncertainty.</span>
<span class="sd">        If a dict is passed then it is directly returned to be passed to</span>
<span class="sd">        `~greykite.algo.forecast.silverkite.forecast_silverkite.SilverkiteForecast.forecast` as `uncertainty_dict`.</span>

<span class="sd">        If &quot;auto&quot;, it builds a generic dict depending on frequency.</span>
<span class="sd">            - For frequencies less than or equal to one day it sets</span>
<span class="sd">              `conditional_cols` to be [&quot;dow_hr&quot;].</span>
<span class="sd">            - Otherwise it sets the conditional_cols to be `None`</span>

<span class="sd">        If None and `coverage` is None, the upper/lower predictions are not returned</span>
<span class="sd">    simple_freq : `str`, optional</span>
<span class="sd">        SimpleTimeFrequencyEnum member that best matches the input data frequency</span>
<span class="sd">        according to `get_simple_time_frequency_from_period`</span>
<span class="sd">    coverage : `float` or None, optional</span>
<span class="sd">        Intended coverage of the prediction bands (0.0 to 1.0)</span>
<span class="sd">        If None and `uncertainty` is None, the upper/lower predictions are not returned</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    uncertainty : `dict` or None</span>
<span class="sd">        An uncertainty dict to be used as input to</span>
<span class="sd">        `~greykite.algo.forecast.silverkite.forecast_silverkite.SilverkiteForecast.forecast`.</span>
<span class="sd">        See that function&#39;s docstring for more details.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">frequency</span> <span class="o">=</span> <span class="n">SimpleTimeFrequencyEnum</span><span class="p">[</span><span class="n">simple_freq</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>

    <span class="c1"># boolean to determine if freq is longer than one day</span>
    <span class="n">freq_is_longer_than_day</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">frequency</span><span class="o">.</span><span class="n">seconds_per_observation</span>
            <span class="o">&gt;</span> <span class="n">SimpleTimeFrequencyEnum</span><span class="o">.</span><span class="n">DAY</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">seconds_per_observation</span><span class="p">)</span>

    <span class="n">uncertainty_dict</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># if both `uncertainty` and `coverage` are None, we return None</span>
    <span class="k">if</span> <span class="n">uncertainty</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">coverage</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="c1"># checking if coverage input is sensible</span>
    <span class="k">if</span> <span class="n">coverage</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="p">(</span><span class="n">coverage</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">coverage</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;coverage must be between 0 and 1&quot;</span><span class="p">)</span>

    <span class="c1"># if only coverage is provided, consider uncertainty to be &quot;auto&quot;</span>
    <span class="k">if</span> <span class="n">coverage</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">uncertainty</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">uncertainty</span> <span class="o">=</span> <span class="s2">&quot;auto&quot;</span>

    <span class="c1"># The case where `uncertainty` is input as a dict</span>
    <span class="c1"># We check if quantiles are passed through `uncertainty`</span>
    <span class="c1"># If not, we use `coverage` to fill them in</span>
    <span class="c1"># If quantiles are passed in `uncertainty` and inferrable from `coverage`:</span>
    <span class="c1"># and they are inconsistent, we throw an Exception</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">uncertainty</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="n">uncertainty_dict</span> <span class="o">=</span> <span class="n">uncertainty</span>
        <span class="c1"># boolean to check if quantiles are passed through uncertainty</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">quantiles_specified</span> <span class="o">=</span> <span class="p">(</span><span class="n">uncertainty</span><span class="p">[</span><span class="s2">&quot;params&quot;</span><span class="p">][</span><span class="s2">&quot;quantiles&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="n">quantiles_specified</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="s2">&quot;params&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">uncertainty_dict</span><span class="p">:</span>
            <span class="n">uncertainty_dict</span><span class="p">[</span><span class="s2">&quot;params&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">if</span> <span class="n">quantiles_specified</span><span class="p">:</span>
            <span class="n">quantiles</span> <span class="o">=</span> <span class="n">uncertainty</span><span class="p">[</span><span class="s2">&quot;params&quot;</span><span class="p">][</span><span class="s2">&quot;quantiles&quot;</span><span class="p">]</span>
            <span class="c1"># If quantiles are specified, we do some sanity checks on their values:</span>
            <span class="c1"># We give warnings if more than two quantiles were passed</span>
            <span class="c1"># or if they are not symmetric i.e. first quantiles distance to zero</span>
            <span class="c1"># is not the same as last quantile distance to 1</span>
            <span class="c1"># We throw exceptions if quantiles are not increasing</span>
            <span class="c1"># or if `coverage` is also passed and inconsistent with `quantiles`</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">quantiles</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                    <span class="s2">&quot;More than two quantiles are passed in `uncertainty`.&quot;</span>
                    <span class="s2">&quot; Confidence intervals will be based on&quot;</span>
                    <span class="s2">&quot; the first (lower limit) and last (upper limit) quantile&quot;</span><span class="p">,</span>
                    <span class="ne">Warning</span><span class="p">)</span>
            <span class="n">coverage_via_uncertainty</span> <span class="o">=</span> <span class="n">quantiles</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">quantiles</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">coverage_via_uncertainty</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;`quantiles` is expected to be an increasing sequence&quot;</span>
                    <span class="s2">&quot; of at least two elements.&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;These quantiles were passed: quantiles = </span><span class="si">{</span><span class="n">quantiles</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">round</span><span class="p">(</span><span class="n">quantiles</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="mi">3</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">round</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">quantiles</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">3</span><span class="p">):</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                    <span class="s2">&quot;1 - (quantiles upper limit) is not equal to (quantiles lower limit)&quot;</span>
                    <span class="s2">&quot; (lack of symmetry).&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot; Asymmetric quantiles: </span><span class="si">{</span><span class="n">quantiles</span><span class="si">}</span><span class="s2"> were used.&quot;</span><span class="p">,</span>
                    <span class="ne">Warning</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">coverage</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># The case where quantiles are both provided through `uncertainty`</span>
                <span class="c1"># and inferrable using `coverage`</span>
                <span class="c1"># We check for conflict in coverage specification</span>
                <span class="k">if</span> <span class="nb">round</span><span class="p">(</span><span class="n">coverage_via_uncertainty</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">round</span><span class="p">(</span><span class="n">coverage</span><span class="p">,</span> <span class="mi">3</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="s2">&quot;Coverage is specified/inferred both via `coverage` and via `uncertainty` input&quot;</span>
                        <span class="s2">&quot; and values do not match.&quot;</span>
                        <span class="sa">f</span><span class="s2">&quot; Coverage specified via `coverage`: </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">coverage</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span><span class="si">}</span><span class="s2">.&quot;</span>
                        <span class="sa">f</span><span class="s2">&quot; Coverage inferred via `uncertainty`: </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">coverage_via_uncertainty</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">quantiles_specified</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">coverage</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;`quantiles` are not specified in `uncertainty`&quot;</span>
                    <span class="s2">&quot; and `coverage` is not provided to infer them&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># The case where quantiles is not provided through `uncertainty`</span>
                <span class="c1"># but coverage is passed</span>
                <span class="n">q1</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">coverage</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>
                <span class="n">q2</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">q1</span>
                <span class="n">uncertainty_dict</span><span class="p">[</span><span class="s2">&quot;params&quot;</span><span class="p">][</span><span class="s2">&quot;quantiles&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">q1</span><span class="p">,</span> <span class="n">q2</span><span class="p">]</span>

    <span class="c1"># The case where `uncertainty` is passed as &quot;auto&quot;</span>
    <span class="c1"># The auto case conditions data on `dow_hr` which represents day of week and hour</span>
    <span class="c1"># for data with frequency less than or equal to a day (e.g. hourly, daily)</span>
    <span class="c1"># note that for daily case this works too as dow_hr will only depend on dow</span>
    <span class="k">if</span> <span class="n">uncertainty</span> <span class="o">==</span> <span class="s2">&quot;auto&quot;</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">freq_is_longer_than_day</span><span class="p">:</span>
            <span class="n">uncertainty_dict</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;uncertainty_method&quot;</span><span class="p">:</span> <span class="s2">&quot;simple_conditional_residuals&quot;</span><span class="p">,</span>
                <span class="s2">&quot;params&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;conditional_cols&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">TimeFeaturesEnum</span><span class="o">.</span><span class="n">dow_hr</span><span class="o">.</span><span class="n">value</span><span class="p">],</span>
                    <span class="s2">&quot;quantiles&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.025</span><span class="p">,</span> <span class="mf">0.975</span><span class="p">],</span>
                    <span class="s2">&quot;quantile_estimation_method&quot;</span><span class="p">:</span> <span class="s2">&quot;normal_fit&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;sample_size_thresh&quot;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
                    <span class="s2">&quot;small_sample_size_method&quot;</span><span class="p">:</span> <span class="s2">&quot;std_quantiles&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;small_sample_size_quantile&quot;</span><span class="p">:</span> <span class="mf">0.98</span><span class="p">}}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">uncertainty_dict</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;uncertainty_method&quot;</span><span class="p">:</span> <span class="s2">&quot;simple_conditional_residuals&quot;</span><span class="p">,</span>
                <span class="s2">&quot;params&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;conditional_cols&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                    <span class="s2">&quot;quantiles&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.025</span><span class="p">,</span> <span class="mf">0.975</span><span class="p">],</span>
                    <span class="s2">&quot;quantile_estimation_method&quot;</span><span class="p">:</span> <span class="s2">&quot;normal_fit&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;sample_size_thresh&quot;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
                    <span class="s2">&quot;small_sample_size_method&quot;</span><span class="p">:</span> <span class="s2">&quot;std_quantiles&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;small_sample_size_quantile&quot;</span><span class="p">:</span> <span class="mf">0.98</span><span class="p">}}</span>
        <span class="c1"># if coverage is provided the quantiles are overridden in auto</span>
        <span class="c1"># we do not give warnings as it is the auto case and</span>
        <span class="c1"># user expects using the coverage provided</span>
        <span class="k">if</span> <span class="n">coverage</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">q1</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">coverage</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>
            <span class="n">q2</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">q1</span>
            <span class="n">uncertainty_dict</span><span class="p">[</span><span class="s2">&quot;params&quot;</span><span class="p">][</span><span class="s2">&quot;quantiles&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">q1</span><span class="p">,</span> <span class="n">q2</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">uncertainty_dict</span></div>


<span class="k">def</span> <span class="nf">get_fourier_feature_col_names</span><span class="p">(</span>
        <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
        <span class="n">time_col</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">fs_func</span><span class="p">:</span> <span class="nb">callable</span><span class="p">,</span>
        <span class="n">conti_year_origin</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Gets the Fourier feature column names.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    df : `pandas.DataFrame`</span>
<span class="sd">        The input data.</span>
<span class="sd">    time_col : `str`</span>
<span class="sd">        The column name for timestamps in ``df``.</span>
<span class="sd">    fs_func : callable</span>
<span class="sd">        The function to generate Fourier features.</span>
<span class="sd">    conti_year_origin : `int` or None, default None</span>
<span class="sd">        The continuous year origin.</span>
<span class="sd">        If None, will be inferred from time column.</span>
<span class="sd">        The names do not depend on this parameter though.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    col_names : `list` [`str`]</span>
<span class="sd">        The list of Fourier feature column names.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">conti_year_origin</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">conti_year_origin</span> <span class="o">=</span> <span class="n">get_default_origin_for_time_vars</span><span class="p">(</span>
            <span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="p">,</span>
            <span class="n">time_col</span><span class="o">=</span><span class="n">time_col</span>
        <span class="p">)</span>
    <span class="n">time_features_example_df</span> <span class="o">=</span> <span class="n">build_time_features_df</span><span class="p">(</span>
        <span class="n">df</span><span class="p">[</span><span class="n">time_col</span><span class="p">][:</span><span class="mi">2</span><span class="p">],</span>
        <span class="n">conti_year_origin</span><span class="o">=</span><span class="n">conti_year_origin</span><span class="p">)</span>
    <span class="n">fs</span> <span class="o">=</span> <span class="n">fs_func</span><span class="p">(</span><span class="n">time_features_example_df</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">fs</span><span class="p">[</span><span class="s2">&quot;cols&quot;</span><span class="p">]</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, LinkedIn.</p>
  </div>

   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>